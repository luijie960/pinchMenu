<!doctype html>
<!--[if IE 6]><html lang="en" class="no-js ie6"><![endif]-->
<!--[if (gt IE 6)|!(IE)]><!--><html lang="en" class="no-js"><!--<![endif]-->
    <head>
        <title>Fitts' Law Tester</title>
        <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scaleable=no">
        
        <link rel="stylesheet" href="https://code.jquery.com/mobile/1.4.0/jquery.mobile-1.4.0.min.css" />
        <script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>
        <script src="https://code.jquery.com/mobile/1.4.0/jquery.mobile-1.4.0.min.js"></script>
        <script src="https://hammerjs.github.io/dist/hammer.js"></script> 
	<script type="text/javascript" src="http://raw.githack.com/hhurz/tableExport.jquery.plugin/master/libs/FileSaver/FileSaver.min.js"></script>
        <script type="text/javascript" src="http://raw.githack.com/hhurz/tableExport.jquery.plugin/master/tableExport.min.js"></script>
	    <script src="http://inorganik.github.io/debugout.js/debugout.js"></script>
        <style>
		
		.cursor {	   
							height:1px;
							top:0px; 
							position:relative;
							z-index:100;
							pointer-events:none;
							display:block;
							color:#0000ff;
							margin:0px;
							
							
						}
            body {
                font-family: Helvetica, sans-serif;
				margin: 0px;
				padding: 0px;
				}
            
            button {
                font-size: larger;
            }
            
            table, th, td {
                border: 1px solid #888888;
                padding: 3px;
                border-collapse:collapse;
                font-size: small;
                text-align: center;
                vertical-align: middle;
            }
            
            .fullscreen {
                position: fixed;
                top: 0px;
                left: 0px;
                width: 100%;
                height: 100%;
                background-color: #ffffff;
            }
            
            .centered {
                width:80%;
                overflow: auto;
                margin-left:auto;
                margin-right: auto;
                padding: 0em 1em 0em 1em;
                text-align: center;
            }
            
            #trial-overlay {
                position: fixed;
                bottom: 0px;
                right: 0px;
                padding: 3px;
                background-color: #ffffff;
                opacity: 0.7;
                border: 1px solid #888888;
                font-size: smaller;
                text-align: right;
            }
			 #debug-overlay {
                position: fixed;
                bottom: 0px;
                left: 0px;
                padding: 3px;
                background-color: #ffffff;
                opacity: 0.7;
                border: 1px solid #888888;
                font-size: smaller;
                text-align: right;
            }
            
            #test-container {
                display: none;
                top:0px;
                -moz-user-select: none;
                -khtml-user-select: none;
                -webkit-user-select: none;
                user-select: none;
            }
            
            #interstitial-overlay {
                background: rgb(255, 255, 255);
                background: rgba(255, 255, 255, .95);
                
                display: none;
            }
            
            #interstitial-box {
                position: absolute;
                padding: 20px;
                top: 50%;
                left: 50%;
                width: 300px;
                height: 300px;
                margin-left: -150px;
                margin-top: -150px;
                font-weight: bold;
                text-align: center;
            }
            
            #results-overlay {
                display: none;
                
                overflow: auto;
                padding: 10px;
                text-align: center;
            }
            
            #debug {
                position: fixed;
                top: 0px;
                right: 0px;
                font-size: x-small;
                text-align: right;
                padding: 3px;
                display:none;

                
                
            }
            
            .ribbon {
                position: fixed;
                top: 0px;
                height: 50px;
                width: 100%;
                background-color: #999999;
            }
            .ribbon.target {
                background-color: #3399ff;
                opacity:0.5
            }
            .ribbon.target.hover {
                color: #FFF;
                opacity:1
            }
            .smaller {
                font-size: smaller;
            }
            
        </style>
        
    </head>
    <body >
        <hr id="cursor" class="cursor"/>
        
        <div id="start-overlay" class="centered">
            <h3>Welcome to the Fitts' Law Testing App</h3>
            <p> Your Name: <input id="name" type="text" value="test" onfocus="if(value==='test')value=''" onblur="if(value==='')value='test'"></p>
            <p>
                Guesture  Type:
                <select id="type">
                    <option value="pinchIn">pinchIn</option>
                    <option value="pinchOut">pinchOut</option>
                    <option value="tap">tap</option>
                </select>
                <br/>
                
                <input id="physicalSizeN" type="radio" name="physicalSize" value="no" onclick='$("#physicalSizeInput").hide();'  checked> 
                <input id="physicalSizeY" type="radio" name="physicalSize" value="yes" onclick='$("#physicalSizeInput").show();' > 
                <label for="physicalSizeN" >without physical size</label> 
                <label for="physicalSizeY" >with physical size</label>
                <div id="physicalSizeInput" style="display:none">  
                <br/>
                Device (i.e. touchpad, mouse...): <input id="device" type="text" value="phone" onfocus="if(value==='phone')value=''" onblur="if(value==='')value='phone'">
                </p>
                <br/>
           
                <p >Please measure the width and height of your screen using a ruler so we can accurately scale the test.</p>
                 <p>
                Width (centimeters):
                <input id="width" type="text"  onkeyup="this.value=this.value.replace(/[^0-9.]/g,'')" value="6.8" onfocus="if(value==='6.8')value=''" onblur="if(value==='')value='6.8'">
                    <br/>
                Height (centimeters):
                <input id="height" type="text"  onkeyup="this.value=this.value.replace(/[^0-9.]/g,'')" value="12.1" onfocus="if(value==='12.1')value=''" onblur="if(value==='')value='12.1'">
                </p>
                <br/>
            </div>
            <p>
                Press the button to begin the test. You're goal is to tap the blue ribbons as QUICKLY and as ACCURATELY as possible. Please be sure not to change the orientation of the device or resize the window. For consistency, be sure to interact the same way throughout the test. It will start with 5 rounds of practice. If you are using a mobile device, please CLOSE THE KEYBOARD before you press start.
                <button id="start_button">Begin Test</button>
            </p>
        </div>
        
        
        
        <div id="results-overlay">
            <h3>Here are the results of your Fitts' law tests.</h3>
            <p>Each test had two variables: the width of the ribbons and the space between the ribbons. For instance, 10_X_20 would mean that the ribbons were 10cm*scaleFactor pt(logic point) wide, and 20cm*scalefactor pt(logic point) apart. Each 'condition' was repeated in random order. All times are in milliseconds.</p>
            <p id="" value='scaleFactor'></p>
            <div id="results-table">
                 <table id="table-elem">
                 </table>
            </div>
            <br/>
            <br/>
            <button id="save-file" style ="width:200px">saveToFile</button>
            <br/>
            <br>
            <button id="download-log" style ="width:200px">downloadLog</button>
            <br/>
            <button id="restart" style ="width:200px">Back</button>
            <br/>
            <button id="exit" style ="width:200px" >Exit</button>
            <div id="results-file-container" class="smaller"></div>
        </div>
        
        
        
        <div id="test-container" class="fullscreen" >
            <div id="ribbon-1" class="ribbon" style="top:50px;"></div>
            <div id="ribbon-2" class="ribbon target" style="top:300px;"></div>
            <div id="trial-overlay">Practice</div>
			<div id="debug-overlay"> debug</div>
            <div id="debug"><ol id="debugitems"><li>debug</li></ol></div>
            <div id="interstitial-overlay" class="fullscreen">
                <div id="interstitial-box">Starting next test in a few seconds...</div>
            </div>
        </div>
        
		<script src="https://hammerjs.github.io/dist/hammer.js"></script>        
        
        
        <script type="text/javascript">
            
            /* Simple Fitts' Law testing script
             *   pardon the hackishness
             *
             *   Jeff Rzeszotarski 2014
             */
            
            // *** Change these conditions to run different tests
      //      var repetitions = 20;
            var heights = [0.2, 0.4, 0.6, 0.8,1];//cm
            var amplitudes = [3, 6, 9];//cm
            var repetitions = 2;
           // var heights = [10, 20, 40,80,160];//px
           // var amplitudes = [40, 80, 160];//px
            // ***
            
            var flash_delay = 130; //msec
            
           
            //Ongoing tests
            var trials;
            var sorted_trial_names;
            var cur_trial;
            var cur_repetition = 0;
            var cur_start_time;
            var trial_flash_queued = false;
            var total_repetitions = -1;//practice one times
            var total_error_count = 0;
            var total_start_time;
            var first_ribbon_is_active = false;
            var results = new Object;
            var isFirstTest = true;
            
            //Device characteristics
            var physical_width;
            var physical_height;
            var resolution_width;
            var resolution_height;
            var window_height;
            var window_width;
            var scalefactor_x;
            var scalefactor_y;
//var for pinch
			var myElement = document.getElementById('test-container');
			var mc = new Hammer(myElement);
			// create a pinch and rotate recognizer
			// these require 2 pointers
		    
			//mc.add(new Hammer.Pinch());
			// mc.on("pinch pinchin pinchout pinchcancel",function (ev){
				
				// $("#debug-overlay").text(ev.type+";Practice:x="+ev.center.x+";y="+ev.center.y);
				// $('#cursor').css('top',ev.center.y+'px');
			// });//move cursor
			
			const PINCH_WAIT_TIME = 5;//at 100ms  5 for 5*100ms
			var overlayTimeCount = 0; 
			var isOnTarget = false;//cursor in target
            //debug log    	
            var bugout = new debugout();
            var exp_num = 0;
            //var exp_distance = 0;
            //var exp_first_time = $.now();
            //var exp_time;
            var cursorOnTarget = 0;
           
            //touch point location
            var p1x = 0;
            var p1y = 0;
            var p2x = 0;
            var p2y = 0;

            //click function for result-overlay
            $('#save-file').click(function(){
                    $('#results-table').tableExport({fileName:$("#name").val()+'-'+$.now(),type:'csv'});
                   alert('saving!');                
                    }) ;
            //click function for log-download 
            $('#download-log').click(function(){bugout.downloadLog();
                exitFullscreen();
                });
            //do test again
            $('#restart').click(function(){
                
                
                cur_repetition = 0;
                trial_flash_queued = false;
                total_repetitions = -1;
                total_error_count = 0;
                first_ribbon_is_active = false;
                isFirstTest = false;

                //for log
                exp_num = 0;
                cursorOnTarget = 0;
                
                //touch point location
                p1x = 0;
                p1y = 0;
                p2x = 0;
                p2y = 0;
                
                $("#cursor").css("display","none");
                $("#start_button").click(submitSetup);
                $("#start_button").prop("disabled",false);
                $("#start_button").text("start");
                $("#results-overlay").hide();
                $("#start-overlay").show();

            });
            $('#exit').click(function(){
                exitFullscreen();
            });
			

			// Find the right method, call on correct element
			function launchIntoFullscreen() {
				//var elem = document.getElementById('test-container');
                var elem = document.documentElement;
                 if(isFull()) return;
				  if (elem.requestFullscreen) {
						elem.requestFullscreen();
					} else if (elem.webkitRequestFullscreen) {
						elem.webkitRequestFullscreen();
					} else if (elem.mozRequestFullScreen) {
						elem.mozRequestFullScreen();
					} else if (elem.msRequestFullscreen) {
						elem.msRequestFullscreen();
					}
					
					// window.screen.lockOrientationUniversal = screen.lockOrientation || screen.mozLockOrientation || screen.msLockOrientation;
					// if (window.screen.lockOrientationUniversal("portrait-primary")) {
					  // // orientation was locked
					  // alert("orientation was locked")
					 
					// } else {
					  // // orientation lock failed
					// alert("orientation lock failed")
					// }	
			}
            function exitFullscreen() {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    } else if (document.msExitFullscreen) {
                        document.msExitFullscreen();
                    } else if (document.mozCancelFullScreen) {
                        document.mozCancelFullScreen();
                    } else if (document.webkitExitFullscreen) {
                        document.webkitExitFullscreen();
                    }
                    }

          
            function isFull() {
                var fullscreenElement =
                    document.fullscreenEnabled
                    || document.mozFullscreenElement
                    || document.webkitFullscreenElement;
                var fullscreenEnabled =
                    document.fullscreenEnabled
                    || document.mozFullscreenEnabled
                    || document.webkitFullscreenEnabled;
                if (fullscreenElement == null)
                {
                    return false;
                } else {
                    return true;
                }
            }
               
            function submitSetup(event) {
                event.stopPropagation();
                
                
                //hack here to make sure physical, resolution, and window dimensions line up
                updateScreenResolution();
                if (!validateForm()) {
                    return;
                }
                if($('input:radio[name="physicalSize"]:checked').val()==='yes')
                {
                    physical_width = parseFloat( $("#width").val() );
                    physical_height = parseFloat( $("#height").val() );
                }
                else
                {//if physical_width or physical_height is empty, using physical resolution
                    physical_width = resolution_width;
                    physical_height = resolution_height;
                }
                var width_is_larger_than_height = physical_width > physical_height;
                
                if (width_is_larger_than_height && resolution_width < resolution_height) {
                    var temp = resolution_width;
                    resolution_width = resolution_height;
                    resolution_height = temp;
                }
                else if (!width_is_larger_than_height && resolution_width >= resolution_height) {
                    var temp = resolution_width;
                    resolution_width = resolution_height;
                    resolution_height = temp;
                }
                if (width_is_larger_than_height && window_width < window_height) {
                    var temp = window_width;
                    window_width = window_height;
                    window_height = temp;
                }
                else if (!width_is_larger_than_height && window_width >= window_height) {
                    var temp = window_width;
                    window_width = window_height;
                    window_height = temp;
                }
                
                if($('input:radio[name="physicalSize"]:checked').val()==='yes')
							 scalefactor_y = resolution_height / physical_height;
                else
                            scalefactor_y = 50;//set to fix value
                            // scalefactor_y = window.devicePixelRatio;//set to fix value
							// scalefactor_x = resolution_width / physical_width;
                
                
                //add debug info
                $("#debug").append($("<li></li>").text("devicePixelRatio: "+scalefactor_y));
                $("#debug").append($("<li></li>").text("screen_width_px: "+window.screen.width));
                $("#debug").append($("<li></li>").text("screen_height_px: "+window.screen.height));
                $("#debug").append($("<li></li>").text("$(window).width: "+$(window).width()));
                $("#debug").append($("<li></li>").text("$(window).height: "+$(window).height()));
                $("#debug").append($("<li></li>").text("window_width_px: "+window_width));
                $("#debug").append($("<li></li>").text("window_height_px: "+window_height));
               
                $("#debug").append($("<li id='bar-name'></li>").text("ribbon_name: "));
                $("#debug").append($("<li id='bar-height'></li>").text("ribbon_pos: "));
                $("#debug").append($("<li id='bar-amplitude'></li>").text("ribbon_amplitude: "));
                $("#debug").append($("<li id='bar1-pos'></li>").text("ribbon1_pos: "));
                $("#debug").append($("<li id='bar2-pos'></li>").text("ribbon2_pos: "));
                
                $("#start_button").unbind();
                $("#start_button").prop("disabled",true);
                $("#start_button").text("Starting...");
				
                hideKeyboard();
				 $("#start-overlay").hide();
				 populateTrials();
                // setTimeout(function() {
                    // $("#start-overlay").hide();
                    // populateTrials();
                // }, 1000)
				
                launchIntoFullscreen();
            }
            
            function validateForm() {
                if($('input:radio[name="physicalSize"]:checked').val()==='yes')
                {
                    w = parseFloat( $("#width").val() );
                    h = parseFloat( $("#height").val() );
                }
                else
                {// using resolution width and height 
                    w = resolution_width;
                    h = resolution_height;
                }
                n = $("#name").val();
                d = $("#device").val();
                
                if (n.length < 1) {
                    alert("You must enter your name.");
                    return false;
                }
                else if (d.length < 1) {
                    alert("You must enter what kind of device you are using.");
                    return false;
                }
                else if (isNaN(w) || w < 1) {
                    alert("You must enter the width of the device's screen in centimeters.");
                    return false;
                }
                else if (isNaN(h) || h < 1) {
                    alert("You must enter the height of the device's screen in centimeters.");
                    return false;
                }
                
                smallest_trial = 1000000000000;
                for (var i=0; i<heights.length; i++) {
                    height = heights[i];
                    for (var j=0; j<amplitudes.length; j++) {
                        amplitude = amplitudes[j];
                        smallest_trial = Math.min(smallest_trial, height + amplitude);
                    }
                }
                if (smallest_trial >= h) {
                    alert("The screen must be at least "+smallest_trial+"cm hight for the test. \nTry reloading the page in landscape mode.");
                    return false;
                }
                
                return true;
            }
            
            function populateTrials() {
                //Using the scale factor and conditions, build a set of tests
                trials = [];
                sorted_trial_names = [];
                for (var i=0; i<heights.length; i++) {
                    height = heights[i];
                    mod_height = scalefactor_y * height;
                    
                    for (var j=0; j<amplitudes.length; j++) {
                        amplitude = amplitudes[j];
                        mod_amplitude = scalefactor_y * amplitude;
                        
                        //make sure the trial does not have ribbons that overlap each other within some tolerance
                        if (mod_amplitude/2.0 - mod_height/2.0 < 0.01) {
                            continue;
                        }
                        
                        
                        //trials are dicts that contain trial information
                        var trial = new Object;
                        trial.name = height + "_X_" + amplitude;
                        trial.height = height;
                        trial.amplitude = amplitude;
                        console.log(window_height+";"+mod_amplitude+";"+mod_height+";"+scalefactor_y+";"+amplitude+";"+height+";");
                          //size of ribbons and location of their top left corners
                        trial.ribbon_height = Math.round(mod_height);
                        trial.ribbon_1_pos = Math.round(window_height/2.0 - mod_amplitude/2.0 - mod_height/2.0);
                        trial.ribbon_2_pos = Math.round(window_height/2.0 + mod_amplitude/2.0 - mod_height/2.0);
                        
                        trials.push(trial);
                        sorted_trial_names.push(trial.name);
                    }
                }
                
                //Randomize the trials
                trials = shuffleArray(trials);
            
                //Present a dummy trial to make sure people understand the interface and have good timing
                height =trials[0].height;
                mod_height = scalefactor_y * height;
                amplitude = trials[0].amplitude;
                mod_amplitude = scalefactor_y * amplitude;
                
                var dummy = new Object;
                dummy.name = null;
                dummy.height = height;
                dummy.amplitude = amplitude;
                
                dummy.ribbon_height = Math.round(mod_height);
                dummy.ribbon_1_pos = Math.round(window_height/2.0 - mod_amplitude/2.0 - mod_height/2.0);
                dummy.ribbon_2_pos = Math.round(window_height/2.0 + mod_amplitude/2.0 - mod_height/2.0);
                
                //Begin the presentTrial recursion
                $("#test-container").show();
                bugout.log("inputNum testNo trialName cur_repetition onTarget hit name type x1 y1 x2 y2 time cur_start_time");
				var guestureType= $('#type option:selected').val();
				if(guestureType==='tap'){
                    $("#test-container").unbind().bind('vmouseup',trialClick);
                    mc.get('pinch').set({ enable:false});
                    
                     }
				else{
                //for pinch
                    
                     $('#cursor').css('display','block');//show cursor

                     mc.get('pinch').set({ enable: true });
					//move cursor
					 mc.on("pinch",function(ev){
					 	$('#cursor').css('top',ev.center.y +'px');
                         //for log, record location for touch point
                        p1x = ev.pointers[0].x;
                        p1y = ev.pointers[0].y;
                        p2x = ev.pointers[1].x;
                        p2y = ev.pointers[1].y;

                         var y = ev.center.y;
                        //find out where active bar is located
                        var minY1 = parseInt($("#ribbon-1").css('top'));
                        var maxY1 = parseInt($("#ribbon-1").css('top')) + parseInt($("#ribbon-1").css('height'));
                        var minY2 = parseInt($("#ribbon-2").css('top'));
                        var maxY2 = parseInt($("#ribbon-2").css('top')) + parseInt($("#ribbon-2").css('height'));
                        
                        if(y >= minY1 && y <= maxY1)
                             $("#ribbon-1").addClass('hover');
                        else 
                            if($("#ribbon-1").hasClass('hover')) $("#ribbon-1").removeClass('hover');
                        if(y >= minY2 && y <= maxY2)
                             $("#ribbon-2").addClass('hover');
                       
                        else 
                            if($("#ribbon-2").hasClass('hover')) $("#ribbon-2").removeClass('hover');    
                        
                                      
                                 
						 });
					//hide cursor
					// mc.on("pinchend",function(ev){
					// 	$('#cursor').css('display','none');
					// });

					mc.on("pinch",trialPinch);
					// if(guestureType==='pinchIn')mc.on("pinchin", trialPinch);
					// else if(guestureType==='pinchOut')mc.on("pinchout", trialPinch);
					// else alert("Wrong gesture type!");
                    setInterval(intervalDo, 100);//
					
				}                  
				cur_repetition = 15;
                cur_trial = dummy;
                presentTrial(dummy);
				
                
            }
            function intervalDo()
            {//count holding time for pinch 
                if(isOnTarget)
                {
                    if(overlayTimeCount<PINCH_WAIT_TIME+10)//<PINCH_WAIT_TIME+10:prevent overload 
                        overlayTimeCount++;

                    if(overlayTimeCount===PINCH_WAIT_TIME)
                    {  
                    
                        //fo log
                        
                        writeLog(1); //writlog must before trialHit
                        
                        trialHit();//successfully  hit
                        
                    }
                }
                else
                {
                    overlayTimeCount = 0;
                    writeLog(0);
                }
               

              

            }
            function queueNextTrial() {
                
                total_repetitions++;
                
                if (cur_repetition < repetitions - 1) {
                    //We have more repetitions of a trial to run
                    cur_repetition++;
                    
                    //update overlay text
                    if (total_repetitions < 0) {
                        $("#trial-overlay").text("Practice");
                    }
                    else {
                        $("#trial-overlay").text("Test #"+(total_repetitions+1));
                    }
                    presentTrial(cur_trial);
                }
                else if (trials.length == 0) {
                    //We're out of trials so we should show results
                    presentResults();
                    return;
                }
                else {
                    
                    //We have to queue a new trial to run
                    cur_trial = trials.shift();
                    cur_repetition = 0;
                    
                    //Check to make sure the trial fits on the screen
                    var fits = false;
                    while (!fits) {
                        var test_size = cur_trial.height + cur_trial.amplitude;
                        //It doesn't fit, so skip it after noting it in results
                        if (test_size >= window_height / scalefactor_y) {
                            results[cur_trial.name] = [];
                            if (trials.length > 0) {
                                cur_trial = trials.shift();
                            }
                            else {
                                break;
                            }
                        }
                        else {
                            fits = true;
                        }
                    }
                    if (!fits && trials.length == 0) {
                        //we've run out things, show results
                        presentResults();
                        return;
                    }
                    
                    //Now that we've queued something, toggle the interstitial screen
                    $(".ribbon").css("backgroundColor","");
                    trial_flash_queued = false;
                    
                   //if($('#type option:selected').val()==='tap') $("#test-container").unbind();
                   //$("#interstitial-overlay").show();   
                   //setInterval(clearInterstitialOverlay, 3000);
                   clearInterstitialOverlay();
                    
                }
                
                
            }
            
            
            function clearInterstitialOverlay(e) {
                $("#interstitial-overlay").hide();
                
                //update overlay text
                if (total_repetitions < 0) {
                    $("#trial-overlay").text("Practice");
                }
                else {
                    $("#trial-overlay").text("Test #"+(total_repetitions+1));
                }
                
               
				if($('#type option:selected').val()==='tap'){$("#test-container").unbind().bind('vmouseup',trialClick);}
                presentTrial(cur_trial);
            }
            
            
            function presentTrial(trial) {
                //position and reset ribbons
                $("#ribbon-1").css("top",trial.ribbon_1_pos);
                $("#ribbon-1").css("height",trial.ribbon_height);
                $("#ribbon-1").removeClass("target");
                $("#ribbon-1").removeClass("inactive");
                
                $("#ribbon-2").css("top",trial.ribbon_2_pos);
                $("#ribbon-2").css("height",trial.ribbon_height);
                $("#ribbon-2").removeClass("target");
                $("#ribbon-2").removeClass("inactive");

                //for debug
               // $("#debug-overlay").text("r1="+trial.ribbon_1_pos+";r2="+trial.ribbon_2_pos); 
               $("#bar1-pos").text("ribbon1_pos:"+trial.ribbon_1_pos);
               $("#bar2-pos").text("ribbon2_pos:"+trial.ribbon_2_pos);
               $("#bar-height").text("ribbon_height:"+trial.ribbon_height);
               $("#bar-amplitude").text("ribbon_amplitude s:"+trial.amplitude);
               $("#bar-name").text("ribbon_name:"+trial.name);

                //alternate active ribbons
                if (total_repetitions % 2 == 0) {
                    first_ribbon_is_active = true;
                    $("#ribbon-1").addClass("target");
                    $("#ribbon-2").addClass("inactive");
                }
                else {
                    first_ribbon_is_active = false;
                    $("#ribbon-1").addClass("inactive");
                    $("#ribbon-2").addClass("target");
                }
                
                //record start time
                cur_start_time = $.now();
                cur_error_count = 0;

                
                
				
                
            }
            
            function trialClick(e) {
               // e.stopPropagation();

                
                
                var x;
                var y;
                $("#debug-overlay").text("event:"+e.type); 
                if (e.pageX != undefined && e.pageY != undefined) {
                    x = e.pageX;
                    y = e.pageY;
                }
                else {
                    x = e.clientX + document.body.scrollLeft +
                        document.documentElement.scrollLeft;
                    y = e.clientY + document.body.scrollTop +
                        document.documentElement.scrollTop;
                }

                
                
                //split the screen down the middle and reject things on the wrong side
                var tap_in_top_half = y < window_height/2;
                var correctScreenRegion = 1;
                if (first_ribbon_is_active && !tap_in_top_half) {  //could do first_ribbon_is_active === !tap_in_left_half
                    //return;
                    correctScreenRegion = 0;
                }
                else if (!first_ribbon_is_active && tap_in_top_half) {
                    //return;
                    correctScreenRegion = 0;
                }
                
                //find out where active bar is located
                var minY = parseInt($(".target").css('top'));
                var maxY = parseInt($(".target").css('top')) + parseInt($(".target").css('height'));

                //for log
                p1x = x;
                p1y = y;
                p2x = -1;
                p2y = -1;
                
               
                if(correctScreenRegion)
                {
                    if (y >= minY && y <= maxY) {
                       
                        //for log
                                               
                        writeLog(1);

                        trialHit();
                    }
                    else {
                        //for log
                                          
                        writeLog(0);
                    //  trialMiss();//must hit target
                    
                    }
                }
                else
                {      
                        writeLog(0);


                }

             
               
            }

        

            function trialPinch(ev) {
                             
                            
                var y;
                y = ev.center.y;
                
                               		
               // $('#cursor').css('top',ev.center.y+'px');        //move cursor    
                $("#debug-overlay").text(ev.type+":x="+ev.center.x+";y="+ev.center.y);                       
                //split the screen down the middle and reject things on the wrong side
                //var tap_in_top_half = y < window_height/2;
                
                // if (first_ribbon_is_active && !tap_in_top_half) {  //could do first_ribbon_is_active === !tap_in_left_half
                //    // return;
                // }
                // else if (!first_ribbon_is_active && tap_in_top_half) {
                //   // return;
                // }
                
                var y = parseInt($('#cursor').css('top'));
                //find out where active bar is located
                var minY = parseInt($(".target").css('top'));
                var maxY = parseInt($(".target").css('top')) + parseInt($(".target").css('height'));
                if(y >= minY && y <= maxY){
                    isOnTarget = true;
                                      
                    // if(overlayTimeCount>PINCH_WAIT_TIME)
                    // {  
                    
                    //     //fo log
                        
                    //     writeLog(1); //writlog must before trialHit
                        
                    //     trialHit();//successfully  hit
                        
                    // }                       
                   
                    
                    						
                                        
                }
                else 
                {
                
                    
                   // if(overlayTimeCount&&countDownTimer)clearTimeout(countDownTimer);
                   isOnTarget = false;
                   
                }
                //$("#debug-overlay").text("overlayTimeCount"+overlayTimeCount); 
            } 

			function overlapCursorJudge(){
				
			}

            function writeLog(isHit)
            {

               var minY = parseInt($(".target").css('top'));
               var maxY = parseInt($(".target").css('top')) + parseInt($(".target").css('height'));
               var y;
               if($('#type option:selected').val()==='tap')
               {//for tap
                    y = p1y;
               }
               else
               {                
                    y = parseInt($('#cursor').css('top'));
                }
                    if(y>=minY&&y<=maxY)
                        cursorOnTarget = 1;
                    else
                        cursorOnTarget = 0;
                    //exp_distance = Math.sqrt(Math.pow((ev.pointers[0].clientX - ev.pointers[1].clientX),2)+Math.pow((ev.pointers[0].clientY - ev.pointers[1].clientY),2));
                    var line =String(++exp_num)+" "+String(total_repetitions)+" "+cur_trial.name+" "+cur_repetition+" "+cursorOnTarget+" "+isHit+" "+$('#name').val()+" "+$('#type').val()+" "+String(p1x)+" "+String(p1y)+" "+String(p2x)+" "+String(p2y)+" "+String($.now())+" "+cur_start_time;
                    //export finger location message
                    //bugout.log("number x1 y1 x2 y2 time distance");
                    bugout.log(line);
               	
            }
            function trialHit() {
                if (typeof(cur_trial.name) == 'undefined' || cur_trial.name == null) {
                    //We've hit the dummy trial, so don't record results, but start the timer
                    total_start_time = $.now();
                }
                else {
                    recordResults(true);
                }
               

                //flash to show hit and queue the next one
                $(".target").css("backgroundColor","#33cc33");
                trial_flash_queued = true;
                setTimeout(function() {
                    $(".ribbon").css("backgroundColor","");
                    trial_flash_queued = false;
                }, flash_delay);
                
                queueNextTrial();
                
                
            }
            function trialMiss() {
                
                if (typeof(cur_trial.name) == 'undefined' || cur_trial.name == null) {
                    //We've hit the dummy trial, so don't record results, but start the timer
                    total_start_time = $.now();
                }
                else {
                    total_error_count++;
                    recordResults(false);
                }
                
                
                //flash to show miss and queue the next one
                $(".target").css("backgroundColor","#cc3333");
                trial_flash_queued = true;
                setTimeout(function() {
                    $(".ribbon").css("backgroundColor","");
                    trial_flash_queued = false;
                }, flash_delay);

                
                queueNextTrial();
            }
            
            function recordResults(was_hit) {
                var end_time = $.now();
                var diff = end_time - cur_start_time;
                
                var result = new Object;
                result.name = cur_trial.name;
                result.repetition = cur_repetition;
                result.hit = was_hit;
                result.time = diff;
                
                //If the results dict does not yet have a list, make one
                if (!results.hasOwnProperty(cur_trial.name)) {
                    results[cur_trial.name] = [];
                }
                results[cur_trial.name].push(result);
            }
            
            
            function presentResults() {

                if($('#type option:selected').val()==='tap')$("#test-container").unbind();
                clearInterval(intervalDo);

                if( $("#results-overlay").is(':visible'))return;
                $("#results-overlay").hide();
                $("#test-container").hide();
                $('#cursor').css('display','none');

                
                
                
                //record end time and compute duration
                var name = $("#name").val();
                var inputType = $("#type").val();
                var device = $("#device").val();
                var end_time = $.now();
                var total_time_spent = end_time - total_start_time;
                var total_error_rate = (parseFloat(total_error_count) / total_repetitions) * 100.0;
                
                //build results table
                var headers = ["Name","InputType","Width","Height","Total_Time(ms)","Total_Error(%)"];
                for (var i=0; i<sorted_trial_names.length; i++) {
                    trial = sorted_trial_names[i];
                    headers.push(trial+"_Avg_Time(ms)");
                   // headers.push(trial+"_Errors(%)");//do not show error rate
                }
                
                var data = [name, inputType, physical_width, physical_height, total_time_spent, total_error_rate];
                for (var i=0; i<sorted_trial_names.length; i++) {
                    result_rows = results[sorted_trial_names[i]];
                    duration = 0.0;
                    num_error = 0.0;
                    if (result_rows == undefined || result_rows.length == 0) {
                        data.push("too big");
                      //  data.push("too big");//do not show error rate
                    }
                    else {
                        for (var j=0; j<result_rows.length; j++) {
                            row = result_rows[j];
                            duration = duration + row.time;
                            if (!row.hit) {
                                num_error++;
                            }
                        }
                        data.push(duration / result_rows.length);
                      //  data.push((num_error / result_rows.length) * 100.0);//do not show error rate
                    }
                }
                
                //build results html
                if(isFirstTest)
                $("#results-table").append(makeTable(data,headers));
                else
                $("#results-table").append(makeTable(data));


                //$("#results-file-container").append(makeCSV(headers,data));

            
                $("#scaleFactor").text("scaleFactor:"+scalefactor_y);//show scalefactor_y
                $("#results-overlay").show();
                
                
            }
            
            function makeTable(data,headers) {
                //var table = $("<table></table>")
                var table = $("#table-elem");
                if(arguments[1])//if have two arguments,use the second as head
                {   var header_tr = $("<tr></tr>")
                    for (var i=0; i<headers.length; i++) {
                        header_tr.append( $("<th></th>").text(headers[i]) );
                    }
                    table.append(header_tr)
                }

                var data_tr = $("<tr></tr>")
                for (var i=0; i<data.length; i++) {
                    data_tr.append( $("<td></td>").text(data[i]) );
                }
                table.append(data_tr)
                
                return table;
            }
            
            function makeCSV(headers, data) {
                var escapeStr = function(str) {
                    str = ""+str;
                    str = str.replace('"','\\"');
                    if (str.indexOf('\n') !== -1 || str.indexOf(',') !== -1 || str.indexOf('\r') !== -1) {
                        str = '"'+str+'"';
                    }
                    return str;
                }
                
                var header_csv = escapeStr(headers[0]);
                for (var i=1; i<headers.length; i++) {
                    header_csv = header_csv + ',' + escapeStr(headers[i]);
                }
                var data_csv = escapeStr(data[0])
                for (var i=1; i<data.length; i++) {
                    data_csv = data_csv + ',' + escapeStr(data[i]);
                }
                return header_csv + '\n' + data_csv;
            }
            
            function updateScreenResolution() {
                //Fix if we're on a mobile device (hopefully)
                if( $.browser.mobile ) {
                    //using physical resolution
                    //width = window.screen.width*window.devicePixelRatio;
                    //height = window.screen.height*window.devicePixelRatio;
                    //using logical resolution
                    width = window.screen.width;
                    height = window.screen.height;
                    window_width = width;
                    window_height = height;
                    resolution_width = width;
                    resolution_height = height;
					//alert("window_width-:"+width+" ;window_height:"+height);
                }
                else {//logical resolution
                   // window_width = $(window).width();
                    //window_height = $(window).height();
                    //physical resolution
                    resolution_width = window.screen.width;
                    resolution_height = window.screen.height;
                    window_width = resolution_width;
                    window_height = resolution_height;
                    //alert("window_width:"+window_width+" ;window_height:"+window_height+";resolution_width:"+window.screen.width+";resolution_height:"+window.screen.height+";window.devicePixelRatio:"+window.devicePixelRatio);
                }
                
            }
            
            
            //care of http://stackoverflow.com/users/310500/laurens-holst
            function shuffleArray(array) {
                for (var i = array.length - 1; i > 0; i--) {
                    var j = Math.floor(Math.random() * (i + 1));
                    var temp = array[i];
                    array[i] = array[j];
                    array[j] = temp;
                }
                return array;
            }
            
            function urlParam(name) {
              var regexS = "[\\?&]"+name+"=([^&#]*)"
              var regex = new RegExp( regexS )
              var tmpURL = window.location.href
              var results = regex.exec( tmpURL )
              if( results == null )
                return ""
              else
                return unescape(results[1].replace(/\+/g,  " "))
            }
            
            //care of http://stackoverflow.com/users/2242956/nisanth-sojan
            function hideKeyboard() {
                document.activeElement.blur();
                $("input").blur();
            };
            
            /*
            * jQuery.browser.mobile will be true if the browser is a mobile device
            * care of detectmobilebrowsers.com w/tablet mod
            **/
            (function(a){(jQuery.browser=jQuery.browser||{}).mobile=/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino|android|ipad|playbook|silk/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))})(navigator.userAgent||navigator.vendor||window.opera);
            
            var init = function() {
                //Called in 'ready'
                
                //Present and bind the starting overlay
                $("#start_button").click(submitSetup);
                
            }
            
            //RUNTIME CALL, DON'T EDIT
            $(function() {
                    init();
            });
            
            
        </script>
    </body>
    
    
</html>
